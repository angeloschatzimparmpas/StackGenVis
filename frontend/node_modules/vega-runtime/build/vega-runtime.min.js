!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util"],e):e((t=t||self).vega={},t.vega,t.vega)}(this,function(t,e,n){"use strict";function r(t,e,n){";"!==e[e.length-1]&&(e="return("+e+");");var r=Function.apply(null,t.concat(e));return n&&n.functions?r.bind(n.functions):r}function a(t,e){return r(["event"],t,e)}function o(t,e){return r(["item","_"],t,e)}function s(t,e,r){var a,o;for(a in r=r||{},t)o=t[a],r[a]=n.isArray(o)?o.map(function(t){return i(t,e,r)}):i(o,e,r);return r}function i(t,e,r){if(!t||!n.isObject(t))return t;for(var a,o=0,s=u.length;o<s;++o)if(a=u[o],n.hasOwnProperty(t,a.key))return a.parse(t,e,r);return t}var u=[{key:"$ref",parse:function(t,e){return e.get(t.$ref)||n.error("Operator not defined: "+t.$ref)}},{key:"$key",parse:function(t,e){var r="k:"+t.$key+"_"+!!t.$flat;return e.fn[r]||(e.fn[r]=n.key(t.$key,t.$flat))}},{key:"$expr",parse:function(t,e,a){t.$params&&s(t.$params,e,a);var o="e:"+t.$expr+"_"+t.$name;return e.fn[o]||(e.fn[o]=n.accessor(function(t,e){return r(["datum","_"],t,e)}(t.$expr,e),t.$fields,t.$name))}},{key:"$field",parse:function(t,e){if(!t.$field)return null;var r="f:"+t.$field+"_"+t.$name;return e.fn[r]||(e.fn[r]=n.field(t.$field,t.$name))}},{key:"$encode",parse:function(t,e){var r,a,s=t.$encode,i={};for(r in s)a=s[r],i[r]=n.accessor(o(a.$expr,e),a.$fields),i[r].output=a.$output;return i}},{key:"$compare",parse:function(t,r){var a="c:"+t.$compare+"_"+t.$order,o=n.array(t.$compare).map(function(t){return t&&t.$tupleid?e.tupleid:t});return r.fn[a]||(r.fn[a]=n.compare(o,t.$order))}},{key:"$context",parse:function(t,e){return e}},{key:"$subflow",parse:function(t,e){var n=t.$subflow;return function(t,r,a){var o=l(n,e.fork()),s=o.get(n.operators[0].id),i=o.signals.parent;return i&&i.set(a),s}}},{key:"$tupleid",parse:function(){return e.tupleid}}];function f(t){return(t+"").toLowerCase()}function c(t,e){"operator"!==f(t.type)&&t.type?e.transform(t,t.type):e.operator(t,t.update?function(t,e){return r(["_"],t,e)}(t.update,e):null)}function d(t,e){var o=n.isObject(o=t.source)?o.$ref:o,i=e.get(o),u=null,f=t.update,c=void 0;i||n.error("Source not defined: "+t.source),u=t.target&&t.target.$expr?a(t.target.$expr,e):e.get(t.target),f&&f.$expr&&(f.$params&&(c=s(f.$params,e)),f=function(t,e){return r(["_","event"],t,e)}(f.$expr,e)),e.update(t,i,u,f,c)}function l(t,e){var r=t.operators||[];return t.background&&(e.background=t.background),t.eventConfig&&(e.eventConfig=t.eventConfig),r.forEach(function(t){c(t,e)}),r.forEach(function(t){!function(t,e){if(t.params){var r=e.get(t.id);r||n.error("Invalid operator id: "+t.id),e.dataflow.connect(r,r.parameters(s(t.params,e),t.react,t.initonly))}}(t,e)}),(t.streams||[]).forEach(function(t){!function(t,e){var r,o=null!=t.filter?a(t.filter,e):void 0,s=null!=t.stream?e.get(t.stream):void 0;t.source?s=e.events(t.source,t.type,o):t.merge&&(s=(r=t.merge.map(e.get.bind(e)))[0].merge.apply(r[0],r.slice(1))),t.between&&(r=t.between.map(e.get.bind(e)),s=s.between(r[0],r[1])),t.filter&&(s=s.filter(o)),null!=t.throttle&&(s=s.throttle(+t.throttle)),null!=t.debounce&&(s=s.debounce(+t.debounce)),null==s&&n.error("Invalid stream definition: "+JSON.stringify(t)),t.consume&&s.consume(!0),e.stream(t,s)}(t,e)}),(t.updates||[]).forEach(function(t){d(t,e)}),e.resolve()}var p={skip:!0};function h(t,e,n){this.dataflow=t,this.transforms=e,this.events=t.events.bind(t),this.signals={},this.scales={},this.nodes={},this.data={},this.fn={},n&&(this.functions=Object.create(n),this.functions.context=this)}function v(t){this.dataflow=t.dataflow,this.transforms=t.transforms,this.functions=t.functions,this.events=t.events,this.signals=Object.create(t.signals),this.scales=Object.create(t.scales),this.nodes=Object.create(t.nodes),this.data=Object.create(t.data),this.fn=Object.create(t.fn),t.functions&&(this.functions=Object.create(t.functions),this.functions.context=this)}h.prototype=v.prototype={fork:function(){var t=new v(this);return(this.subcontext||(this.subcontext=[])).push(t),t},get:function(t){return this.nodes[t]},set:function(t,e){return this.nodes[t]=e},add:function(t,e){var n,r=this,a=r.dataflow;if(r.set(t.id,e),"collect"===f(t.type)&&(n=t.value)&&(n.$ingest?a.ingest(e,n.$ingest,n.$format):n.$request?a.preload(e,n.$request,n.$format):a.pulse(e,a.changeset().insert(n))),t.root&&(r.root=e),t.parent){var o=r.get(t.parent.$ref);o?(a.connect(o,[e]),e.targets().add(o)):(r.unresolved=r.unresolved||[]).push(function(){o=r.get(t.parent.$ref),a.connect(o,[e]),e.targets().add(o)})}if(t.signal&&(r.signals[t.signal]=e),t.scale&&(r.scales[t.scale]=e),t.data)for(var s in t.data)n=r.data[s]||(r.data[s]={}),t.data[s].forEach(function(t){n[t]=e})},resolve:function(){return(this.unresolved||[]).forEach(function(t){t()}),delete this.unresolved,this},operator:function(t,e){this.add(t,this.dataflow.add(t.value,e))},transform:function(t,e){this.add(t,this.dataflow.add(this.transforms[f(e)]))},stream:function(t,e){this.set(t.id,e)},update:function(t,e,n,r,a){this.dataflow.on(e,n,r,a,t.options)},getState:function(t){var e=this,n={};if(t.signals){var r=n.signals={};Object.keys(e.signals).forEach(function(n){var a=e.signals[n];t.signals(n,a)&&(r[n]=a.value)})}if(t.data){var a=n.data={};Object.keys(e.data).forEach(function(n){var r=e.data[n];t.data(n,r)&&(a[n]=r.input.value)})}return e.subcontext&&!1!==t.recurse&&(n.subcontext=e.subcontext.map(function(e){return e.getState(t)})),n},setState:function(t){var e=this,r=e.dataflow,a=t.data,o=t.signals;Object.keys(o||{}).forEach(function(t){r.update(e.signals[t],o[t],p)}),Object.keys(a||{}).forEach(function(t){r.pulse(e.data[t].input,r.changeset().remove(n.truthy).insert(a[t]))}),(t.subcontext||[]).forEach(function(t,n){var r=e.subcontext[n];r&&r.setState(t)})}},t.context=function(t,e,n){return new h(t,e,n)},t.expression=r,t.parse=l,Object.defineProperty(t,"__esModule",{value:!0})});