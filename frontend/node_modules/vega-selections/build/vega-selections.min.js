!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-expression")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-expression"],t):t((e=e||self).vega={},e.vega,e.vega)}(this,(function(e,t,n){"use strict";const r="intersect",i="union",u="vlMulti",o="or",a="and";var f="E",s="R",l="R-E",c="R-LE",d="R-RE",g="index:unit";function v(e,n){for(var r,i,u=n.fields,o=n.values,a=u.length,g=0;g<a;++g)if((i=u[g]).getter=t.field.getter||t.field(i.field),r=i.getter(e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(o[g])&&(o[g]=t.toNumber(o[g])),t.isDate(o[g][0])&&(o[g]=o[g].map(t.toNumber)),i.type===f){if(t.isArray(o[g])?o[g].indexOf(r)<0:r!==o[g])return!1}else if(i.type===s){if(!t.inrange(r,o[g]))return!1}else if(i.type===d){if(!t.inrange(r,o[g],!0,!1))return!1}else if(i.type===l){if(!t.inrange(r,o[g],!1,!1))return!1}else if(i.type===c&&!t.inrange(r,o[g],!1,!0))return!1;return!0}var p={E_union:function(e,t){if(!e.length)return t;for(var n=0,r=t.length;n<r;++n)e.indexOf(t[n])<0&&e.push(t[n]);return e},E_intersect:function(e,t){return e.length?e.filter((function(e){return t.indexOf(e)>=0})):t},R_union:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?(e[0]>r&&(e[0]=r),e[1]<i&&(e[1]=i),e):[r,i]},R_intersect:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?i<e[0]||e[1]<r?[]:(e[0]<r&&(e[0]=r),e[1]>i&&(e[1]=i),e):[r,i]}};const h=":",y="@";e.selectionResolve=function(e,n,r){for(var f,s,l,c,d,g,v,h,y,m,b,x=this.context.data[e],R=x?x.values.value:[],O={},_={},E={},N=R.length,j=0;j<N;++j){for(c=(f=R[j]).unit,s=f.fields,l=f.values,m=0,b=s.length;m<b;++m)d=s[m],v=(g=O[d.field]||(O[d.field]={}))[c]||(g[c]=[]),E[d.field]=h=d.type.charAt(0),y=p[h+"_union"],g[c]=y(v,t.array(l[m]));r&&(v=_[c]||(_[c]=[])).push(t.array(l).reduce((e,t,n)=>(e[s[n].field]=t,e),{}))}return n=n||i,Object.keys(O).forEach((function(e){O[e]=Object.keys(O[e]).map(t=>O[e][t]).reduce((t,r)=>void 0===t?r:p[E[e]+"_"+n](t,r))})),R=Object.keys(_),r&&R.length&&(O[u]=n===i?{[o]:R.reduce((e,t)=>(e.push.apply(e,_[t]),e),[])}:{[a]:R.map(e=>({[o]:_[e]}))}),O},e.selectionTest=function(e,t,n){for(var i,u,o,a,f,s=this.context.data[e],l=s?s.values.value:[],c=s?s[g]&&s[g].value:void 0,d=n===r,p=l.length,h=0;h<p;++h)if(i=l[h],c&&d){if(-1===(o=(u=u||{})[a=i.unit]||0))continue;if(f=v(t,i),u[a]=f?-1:++o,f&&1===c.size)return!0;if(!f&&o===c.get(a).count)return!1}else if(d^(f=v(t,i)))return f;return p&&d},e.selectionVisitor=function(e,i,u,o){i[0].type!==n.Literal&&t.error("First argument to selection functions must be a string literal.");const a=i[0].value,f=i.length>=2&&t.peek(i).value,s=y+"unit",l=h+a;f!==r||t.hasOwnProperty(o,s)||(o[s]=u.getData(a).indataRef(u,"unit")),t.hasOwnProperty(o,l)||(o[l]=u.getData(a).tuplesRef())},Object.defineProperty(e,"__esModule",{value:!0})}));