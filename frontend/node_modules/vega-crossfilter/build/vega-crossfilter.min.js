!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3-array"),require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","d3-array","vega-dataflow","vega-util"],r):r(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.d3,e.vega,e.vega)}(this,function(e,r,n,i){"use strict";function t(e){return new Uint32Array(e)}function a(e,r,n){var i=(r<257?function(e){return new Uint8Array(e)}:r<65537?function(e){return new Uint16Array(e)}:t)(e);return n&&i.set(n),i}function o(e,r,n){var i=1<<r;return{one:i,zero:~i,range:n.slice(),bisect:e.bisect,index:e.index,size:e.size,onAdd:function(e,r){var n,t=this.bisect(this.range,e.value),a=e.index,o=t[0],f=t[1],s=a.length;for(n=0;n<o;++n)r[a[n]]|=i;for(n=f;n<s;++n)r[a[n]]|=i;return this}}}function f(){var e=t(0),n=[],i=0;return{insert:function(a,o,f){if(!o.length)return[];var s,u,l,d=i,c=o.length,h=Array(c),m=t(c);for(l=0;l<c;++l)h[l]=a(o[l]),m[l]=l;if(h=function(e,n){return e.sort.call(n,function(r,n){var i=e[r],t=e[n];return i<t?-1:i>t?1:0}),r.permute(e,n)}(h,m),d)s=n,u=e,n=Array(d+c),e=t(d+c),function(e,r,n,i,t,a,o,f,s){var u,l=0,d=0;for(u=0;l<i&&d<o;++u)r[l]<t[d]?(f[u]=r[l],s[u]=n[l++]):(f[u]=t[d],s[u]=a[d++]+e);for(;l<i;++l,++u)f[u]=r[l],s[u]=n[l];for(;d<o;++d,++u)f[u]=t[d],s[u]=a[d]+e}(f,s,u,d,h,m,c,n,e);else{if(f>0)for(l=0;l<c;++l)m[l]+=f;n=h,e=m}return i=d+c,{index:m,value:h}},remove:function(r,t){var a,o,f,s=i;for(o=0;!t[e[o]]&&o<s;++o);for(f=o;o<s;++o)t[a=e[o]]||(e[f]=a,n[f]=n[o],++f);i=s-r},bisect:function(e,t){var a;return t?a=t.length:(t=n,a=i),[r.bisectLeft(t,e[0],0,a),r.bisectRight(t,e[1],0,a)]},reindex:function(r){for(var n=0,t=i;n<t;++n)e[n]=r[e[n]]},index:function(){return e},size:function(){return i}}}function s(e){var r,i,o,f,s;n.Transform.call(this,(r=8,i=[],o=t(0),f=a(0,r),s=a(0,r),{data:function(){return i},seen:function(){return e=o,r=i.length,o=e.length>=r?e:((n=n||new e.constructor(r)).set(e),n);var e,r,n},add:function(e){for(var r,n=0,t=i.length,a=e.length;n<a;++n)(r=e[n])._index=t++,i.push(r)},remove:function(e,r){var n,t,a,o=i.length,u=Array(o-e),l=i;for(t=0;!r[t]&&t<o;++t)u[t]=i[t],l[t]=t;for(a=t;t<o;++t)n=i[t],r[t]?l[t]=-1:(l[t]=a,f[a]=f[t],s[a]=s[t],u[a]=n,n._index=a++),f[t]=0;return i=u,l},size:function(){return i.length},curr:function(){return f},prev:function(){return s},reset:function(e){s[e]=f[e]},all:function(){return r<257?255:r<65537?65535:4294967295},set:function(e,r){f[e]|=r},clear:function(e,r){f[e]&=~r},resize:function(e,n){(e>f.length||n>r)&&(r=Math.max(n,r),f=a(e,r,f),s=a(e,r))}}),e),this._indices=null,this._dims=null}s.Definition={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"query",type:"array",array:!0,required:!0,content:{type:"number",array:!0,length:2}}]};var u=i.inherits(s,n.Transform);function l(e){n.Transform.call(this,null,e)}u.transform=function(e,r){return this._dims?e.modified("fields")||e.fields.some(function(e){return r.modified(e.fields)})?this.reinit(e,r):this.eval(e,r):this.init(e,r)},u.init=function(e,r){for(var n,i,t=e.fields,a=e.query,s=this._indices={},u=this._dims=[],l=a.length,d=0;d<l;++d)i=s[n=t[d].fname]||(s[n]=f()),u.push(o(i,d,a[d]));return this.eval(e,r)},u.reinit=function(e,r){var n,i,t,a,s,u,l,d,c,h=r.materialize().fork(),m=e.fields,v=e.query,g=this._indices,p=this._dims,y=this.value,x=y.curr(),_=y.prev(),b=y.all(),A=h.rem=h.add,q=h.mod,M=v.length,z={};if(_.set(x),r.rem.length&&(s=this.remove(e,r,h)),r.add.length&&y.add(r.add),r.mod.length)for(u={},l=0,d=(a=r.mod).length;l<d;++l)u[a[l]._index]=1;for(l=0;l<M;++l)c=m[l],(!p[l]||e.modified("fields",l)||r.modified(c.fields))&&((n=z[t=c.fname])||(g[t]=i=f(),z[t]=n=i.insert(c,r.source,0)),p[l]=o(i,l,v[l]).onAdd(n,x));for(l=0,d=y.data().length;l<d;++l)s[l]||(_[l]!==x[l]?A.push(l):u[l]&&x[l]!==b&&q.push(l));return y.mask=(1<<M)-1,h},u.eval=function(e,r){var n=r.materialize().fork(),i=this._dims.length,t=0;return r.rem.length&&(this.remove(e,r,n),t|=(1<<i)-1),e.modified("query")&&!e.modified("fields")&&(t|=this.update(e,r,n)),r.add.length&&(this.insert(e,r,n),t|=(1<<i)-1),r.mod.length&&(this.modify(r,n),t|=(1<<i)-1),this.value.mask=t,n},u.insert=function(e,r,n){var i,t,a,o=r.add,f=this.value,s=this._dims,u=this._indices,l=e.fields,d={},c=n.add,h=f.size(),m=h+o.length,v=s.length;f.resize(m,v),f.add(o);var g=f.curr(),p=f.prev(),y=f.all();for(i=0;i<v;++i)a=d[t=l[i].fname]||(d[t]=u[t].insert(l[i],o,h)),s[i].onAdd(a,g);for(;h<m;++h)p[h]=y,g[h]!==y&&c.push(h)},u.modify=function(e,r){var n,i,t,a=r.mod,o=this.value,f=o.curr(),s=o.all(),u=e.mod;for(n=0,i=u.length;n<i;++n)f[t=u[n]._index]!==s&&a.push(t)},u.remove=function(e,r,n){var i,t,a,o,f=this._indices,s=this.value,u=s.curr(),l=s.prev(),d=s.all(),c={},h=n.rem,m=r.rem;for(i=0,t=m.length;i<t;++i)c[a=m[i]._index]=1,l[a]=o=u[a],u[a]=d,o!==d&&h.push(a);for(a in f)f[a].remove(t,c);return this.reindex(r,t,c),c},u.reindex=function(e,r,n){var i=this._indices,t=this.value;e.runAfter(function(){var e=t.remove(r,n);for(var a in i)i[a].reindex(e)})},u.update=function(e,r,n){var i,t,a=this._dims,o=e.query,f=r.stamp,s=a.length,u=0;for(n.filters=0,t=0;t<s;++t)e.modified("query",t)&&(i=t,++u);if(1===u)u=a[i].one,this.incrementOne(a[i],o[i],n.add,n.rem);else for(t=0,u=0;t<s;++t)e.modified("query",t)&&(u|=a[t].one,this.incrementAll(a[t],o[t],f,n.add),n.rem=n.add);return u},u.incrementAll=function(e,r,n,i){var t,a,o,f=this.value,s=f.seen(),u=f.curr(),l=f.prev(),d=e.index(),c=e.bisect(e.range),h=e.bisect(r),m=h[0],v=h[1],g=c[0],p=c[1],y=e.one;if(m<g)for(t=m,a=Math.min(g,v);t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;else if(m>g)for(t=g,a=Math.min(m,p);t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;if(v>p)for(t=Math.max(m,p),a=v;t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;else if(v<p)for(t=Math.max(g,v),a=p;t<a;++t)s[o=d[t]]!==n&&(l[o]=u[o],s[o]=n,i.push(o)),u[o]^=y;e.range=r.slice()},u.incrementOne=function(e,r,n,i){var t,a,o,f=this.value.curr(),s=e.index(),u=e.bisect(e.range),l=e.bisect(r),d=l[0],c=l[1],h=u[0],m=u[1],v=e.one;if(d<h)for(t=d,a=Math.min(h,c);t<a;++t)f[o=s[t]]^=v,n.push(o);else if(d>h)for(t=h,a=Math.min(d,m);t<a;++t)f[o=s[t]]^=v,i.push(o);if(c>m)for(t=Math.max(d,m),a=c;t<a;++t)f[o=s[t]]^=v,n.push(o);else if(c<m)for(t=Math.max(h,c),a=m;t<a;++t)f[o=s[t]]^=v,i.push(o);e.range=r.slice()},l.Definition={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:!0,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:!0,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]},i.inherits(l,n.Transform).transform=function(e,r){var n=~(e.ignore||0),i=e.filter,t=i.mask;if(0==(t&n))return r.StopPropagation;var a=r.fork(r.ALL),o=i.data(),f=i.curr(),s=i.prev(),u=function(e){return f[e]&n?null:o[e]};return a.filter(a.MOD,u),t&t-1?(a.filter(a.ADD,function(e){var r=f[e]&n;return!r&&r^s[e]&n?o[e]:null}),a.filter(a.REM,function(e){var r=f[e]&n;return r&&!(r^r^s[e]&n)?o[e]:null})):(a.filter(a.ADD,u),a.filter(a.REM,function(e){return(f[e]&n)===t?o[e]:null})),a.filter(a.SOURCE,function(e){return u(e._index)})},e.crossfilter=s,e.resolvefilter=l,Object.defineProperty(e,"__esModule",{value:!0})});